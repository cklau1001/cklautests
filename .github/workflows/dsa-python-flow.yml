name: DSA Python workflow
run-name: ${{ github.actor }}
on:
  push:
    paths:
      - dsa/python/**
env:
  CHECKOUT_PATH: 'dsa/python'
  PYTHON_VERSION: '3.13'

jobs:
  init-workflow:
    runs-on: ubuntu-latest
    outputs:
      checkout_path: ${{ steps.init_checkout_path.outputs.checkout_path }}
      python_version: ${{ steps.init_version.outputs.python_version }}
    steps:
      - name: Initialize CHECKOUT_PATH
        id: init_checkout_path
        run: echo "checkout_path=$CHECKOUT_PATH" >> $GITHUB_OUTPUT
      - name: Initialize PYTHON_VERSION
        id: init_version
        run: echo "python_version=$PYTHON_VERSION" >> $GITHUB_OUTPUT

  python-lint:
    permissions:
      statuses: write
      contents: read
    uses: ./.github/workflows/linter-python-subflow.yml
    with:
      checkout_path: ${{ needs.init-workflow.outputs.checkout_path }}
    needs: [init-workflow]

  dsa-python-workflow:
    needs: [python-lint]
    runs-on: ubuntu-latest
    steps:
      - run: echo "DSA Python workflow triggered by ${{ github.event_name }} event."
      - run: echo "Runner=${{ runner.os }}, branch=${{ github.ref }}, repo=${{ github.repository }}"
      - name: Check out code on ${{ env.CHECKOUT_PATH }}
        uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ env.CHECKOUT_PATH }}
          sparse-checkout-cone-mode: false
      - run: echo "Code checked out"
      - name: Listing files
        run: |
          ls ${{ github.workspace }}
          echo " "
          ls ${{ github.workspace }}/$CHECKOUT_PATH
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Show Python version
        run: python -c "import sys; print(sys.version)"
      - name: Install dependencies
        working-directory: ./${{ env.CHECKOUT_PATH }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - run: echo "Job status is ${{ job.status }}"
